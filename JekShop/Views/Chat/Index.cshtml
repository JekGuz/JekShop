@model JekShop.Models.Chat.ChatViewModel

@{
    ViewData["Title"] = "Chat";
}

<div class="row">
    <!-- Левая колонка: ввод сообщения -->
    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0">Uus sõnum</h4>
            </div>

            <div class="card-body">

                <!-- Teema -->
                <div class="mb-3">
                    <label asp-for="Subject" class="form-label">Teema</label>
                    <input asp-for="Subject" class="form-control" id="Subject" />
                </div>

                <!-- Sisu -->
                <div class="mb-3">
                    <label asp-for="Body" class="form-label">Sisu</label>
                    <textarea asp-for="Body" class="form-control" rows="5" id="Body"></textarea>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" id="sendButton">
                        Saada sõnum
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Правая колонка: чат -->
    <div class="col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h4 class="mb-0">Chat</h4>
            </div>
            <div class="card-body">
                <ul id="messagesList"
                    class="list-unstyled mb-0"
                    style="max-height: 500px; overflow-y: auto;">
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="~/js/signalr.js"></script>

    <script>
        // 1. создаём соединение
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/chat")   // тот же путь, что в Program.cs
            .build();

        // 2. обработчик получения сообщений
        connection.on("ReceiveMessage", (subject, body) => {
            const li = document.createElement("li");
            li.className = "mb-3";
            li.innerHTML = `
                <div class="border rounded p-2 bg-light">
                    <div class="fw-semibold">${subject || "(ilma teemata)"}</div>
                    <div class="small mt-1" style="white-space: pre-wrap;">${body || ""}</div>
                </div>`;
            const list = document.getElementById("messagesList");
            list.appendChild(li);
            list.scrollTop = list.scrollHeight;
        });

        // 3. навешиваем обработчик на кнопку после загрузки DOM
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("sendButton");
            console.log("Push the button:", btn); // проверка

            if (!btn) return;

            btn.addEventListener("click", function () {
                const subject = document.getElementById("Subject").value;
                const body = document.getElementById("Body").value;

                if (!subject && !body) return;

                if (connection.state !== signalR.HubConnectionState.Connected) {
                    console.warn("Dont ready connect");
                    return;
                }

                connection.invoke("SendMessage", subject, body)
                    .then(() => {
                        document.getElementById("Body").value = "";
                    })
                    .catch(err => console.error("invoke error:", err.toString()));
            });
        });

        // 4. запускаем соединение
        connection.start()
            .then(() => console.log("SignalR connected"))
            .catch(err => console.error("connection error:", err.toString()));
    </script>
}
